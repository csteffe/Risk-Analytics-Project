---
title: "Practical 2"
author: "Colin Steffe, Virany Kho, Jasmine Mawjee, Adela Sahraoui"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
---


```{r, echo=F, warning=F, message=F}
library(here)
library(quantmod)  
library(dplyr)
library(tidyverse)
library(ggplot2)
library(plotly)
library(tidyquant)

# Read in the data
load(file = here::here("stocks.Rdata"))
```

# Candlestick Plot {.tabset}

## Stocks Gathered

Below is displayed the candlestick plot including the four stocks prices. Since Amazon has a much higher stock price (~1000$) than other stocks, it takes the most prominent size on the below plot compared to the others.  You can use the zoom to see the detail of the three other stocks price evolution over time. 

```{r, echo=F, warning=F, message=F}

  #rect()
# fig.rect <- stocks %>% plot_ly( x = ~stocks$ref.date, type = "candlestick",
#                     open = ~stocks$price.open, close = ~stocks$price.close,
#                     high = ~stocks$price.high, low = ~stocks$price.low) %>% 
#   layout(title = "Stock Prices Candlestick Chart rect()")
# fig.rect

  #segments()

fig.seg <- plot_ly(stocks, x = ~stocks$ref.date, xend = ~stocks$ref.date, color = ~stocks$price.close > stocks$price.open,
             colors = c("red", "forestgreen"), hoverinfo = "none") 
fig.seg <- fig.seg %>% add_segments(y = ~stocks$price.low, yend = ~stocks$price.high, size = I(1)) 
fig.seg <- fig.seg %>% add_segments(y = ~stocks$price.open, yend = ~stocks$price.close, size = I(3)) 
fig.seg <- fig.seg %>% layout(title = "Stock Prices Candlestick Chart segments()", showlegend =FALSE, yaxis = list(title = "Price")) 
fig.seg <- fig.seg %>% rangeslider()

fig.seg
```

## Stock Prices Separately

```{r, echo=F, warning=F, message=F}
dif.stocks <- unique(stocks$ticker)

for (i in 1:length(dif.stocks)){

fig.rect <- stocks %>% 
            filter (ticker == dif.stocks[i]) %>% 
            plot_ly( x = ~stocks$ref.date, type = "candlestick",
                    open = ~stocks$price.open, close = ~stocks$price.close,
                    high = ~stocks$price.high, low = ~stocks$price.low) %>% 
            layout(title = paste( dif.stocks[i], "stock Prices Candlestick "))
fig.rect

print(fig.rect)
}
```

# Log-Returns

For all four stocks, it seems that the mean of the log-returns is 0 or close to 0 and that they are stationary. *AAPL* and *AMZN* become more volatile in 2019 and their shapes seem to be skewed. *NVDA* and *TSLA* seem to be more volatile and their shapes seem to indicate they follow a normal distribution. 

```{r, echo=F, warning=F, message=F}

forth_log <- stocks

log_returns <- data.frame(matrix(NA, nrow = nrow(forth_log), ncol = 1))
colnames(log_returns) <- "neg_log_returns"

for (i in 1:nrow(forth_log)){
  return_i <- - log(forth_log$price.close[i+1]/forth_log$price.close[i])
  
  log_returns$neg_log_returns[i] <- return_i
}

log_returns <- cbind(forth_log,log_returns)

log_returns %>% 
  ggplot(aes(x = ref.date, y = neg_log_returns )) + 
  geom_line() +
  facet_wrap(~ticker) +
  ylim(-0.1,0.1)

```
# Peak-Over-Threshold 

We choose a threshold of 0.05 based on the mean residual plot. We plot the mean over and we use a peak over threshold model and display its estimate of the uncertainty  

```{r, echo=F, warning=F, message=F}

library(extRemes)

log_returns_NoNA <- log_returns %>% filter(!is.na(neg_log_returns))
log_returns_NoNA <- log_returns_NoNA %>% filter(ticker == "TSLA")
# Mean Residual Life Plot (MRLP)
extRemes::mrlplot(log_returns_NoNA$neg_log_returns,
                  main = "Mean Residual Life Plot: Mean Excess Function") 

threshold <- 0.05 # 0.05 seems to be a good threshold for Tesla

# Plot of Peak-over-Threshold
pot <- plot(x = rep(1:755, 
                    each = 1), 
            y = unlist(log_returns_NoNA$neg_log_returns), 
            main = "Peak-Over-Threshold plot: Exceedances",
            sub = paste("threshold =", threshold), 
            xlab = "Observations", 
            ylab = "Threshold")

pot_points <- unlist(log_returns_NoNA$neg_log_returns) > threshold

points(x = rep(1:755, each = 1)[pot_points], 
       y = unlist(log_returns_NoNA$neg_log_returns)[pot_points], 
       col = "red")

abline(h = threshold, col = "red") 

pof.model <- fpot(log_returns_NoNA$neg_log_returns, threshold = 0.05, mper = 0.95)

uncertainty <- pof.model$std.err

print("uncertainty")
print(uncertainty)

```

We will now fit our stocks data of the upper tail beyond the chosen threshold of 0.05 to a GPD method.
```{r, echo=F, warning=F, message=F}
library(ismev)

# Fit our data of the upper tail beyond threshold of 0.05 to a GPD
gpd_fit <- gpd.fit(log_returns_NoNA$neg_log_returns, 0.05)

```
By using the POT approach, we built a model for high values of the negative log-returns where we obtain the Maximum Likelihood Estimates for the scale (sigma) and shape (ksi) parameters/coefficients : 0.01965532 and 0.60647468, with Standard Errors being 0.00558524 and 0.24858608.




d)

```{r, echo=F, warning=F, message=F}
library(ggplot2)



# compute value at risks
quantile(log_returns_NoNA$neg_log_returns , 0.05)

#plot value at risk
qplot(log_returns_NoNA$neg_log_returns , geom = 'histogram') + geom_histogram(fill = 'lightblue' , bins = 30) +
    geom_histogram(aes(log_returns_NoNA$neg_log_returns[log_returns_NoNA$neg_log_returns < quantile(log_returns_NoNA$neg_log_returns , 0.05)]) , fill = 'red' , bins = 30) +
    labs(x = 'Negative log returns')+xlim(-0.20,0.20)

```

