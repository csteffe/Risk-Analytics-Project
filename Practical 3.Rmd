---
title: "Practical 3: Web Traffic"
author: "Colin Steffe, Virany Kho, Jasmine Mawjee, Adela Sahraoui"
date: "11/25/2021"
output: html_document
---

```{r data preparation, echo=F, message=F, warning=F}

library(here)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(fpp3)

# Read in the data
load(file = here::here("traffic.Rdata"))

# Convert into tibble 
pageviews <- as_tibble(pageviews)

# Create new column
type <- c("Elizabeth_II", 
          "United_States",
          "Queen_Victoria",
          "World_War_II",
          "World_War_I",
          "George_VI",
          "United_Kingdom",
          "Princess_Margaret,_Countess_of_Snowdon",
          "Prince_Philip,_Duke_of_Edinburgh",
          "Winston_Churchill",
          "Diana,_Princess_of_Wales",
          "2016_Summer_Olympics")

# Add new column
pageviews <- cbind(pageviews,
                   type)

# Reorder colum
pageviews <- pageviews[, c(804, 1:803)]

# Pivot data frame 
pageviews <- pageviews %>% 
             pivot_longer(!type, 
                          names_to = "date", 
                          values_to = "dailycount")

# Convert column date into date format
pageviews$date <- as.Date(pageviews$date, format = "%Y-%m-%d")

# Convert into tsibble
pageviews_ts <- tsibble(pageviews, 
                        index = date,
                        key = c(type, dailycount)) # since duplicates need to keys

# str(pageviews_ts) # to verify the structure of dataframe

```

# Informative Plots

## Time Series

If we see a trend, the time series is not stationary (i.e. does not depend on the time of the observation). 

```{r time series plot, echo=F, message=F, warning=F}

library(plotly)

ts_plot <- pageviews_ts %>%
           ggplot(mapping = aes(x = date, 
                                y = dailycount,
                                colour = factor(type))) +
           geom_line() +
  
           labs(title = "Web Traffic: Daily Count",
                x = "Time of Occurrence [1D]", 
                y = "Daily count",
                fill = type)  +
  
           theme_economist_white() # we can change the theme for something cooler ? 

ggplotly(ts_plot) %>% 
  config(displayModeBar = T) # can we add the woom opt on the x axis ? 
  
# NEED IMPROVEMENT UNREADABLE 
  
```

## Seasonal plot

If we see a seasonality, the time series is not stationary (i.e. does not depend on the time of the observation). 

```{r seasonal plot, echo=F, message=F, warning=F}

library(tsibble)

# Fill time gaps
pageviews_nogaps <- pageviews_ts %>%
                    fill_gaps()

```

### Elizabeth_II

Je sais pas pk ca tourne pdt mille ans sans voir le résultat

```{r seasonal Elizabeth_II, echo=F, message=F, warning=F}

library(feasts)

# Seasonal plot
eliz_seasonal <- pageviews_nogaps %>% 
                 filter(type == "Elizabeth_II") %>%
                 gg_season(y = dailycount) 

# Subseries
eliz_sub <- pageviews_nogaps %>% 
            filter(type == "Elizabeth_II") %>%
            gg_subseries(y = dailycount) 



```

- time series decompostion

## Autocorrelation plot

Autocorrelation quantifies the relationship between lagged values of a time series.

# Modified Series

$$
R_i = \frac{X_i - X_{i-7}}{X_{i-7}} * 100
$$
$R_i$ is the modified time series where each series (above $R_8$) of pageviews is the percentage difference between one series and the seventh one before ? 

```{r modified time series, echo=F, message=F, warning=F}

# pour chaque "type" on crée une time series modifiée "modified_ts" pour lesquelles on recalcules la valeur de daily count en utilisant la formule du dessus. etant donné qu'on a - Xi-7 on peut que commencer à calculer pour la 8ème observation de chaque time series (1 par type)

type <- as.factor(type)

# Create a modified time series using the initial one
modified_ts <- pageviews_ts
    
for (i in levels(type)) {
  
  for (j in length(levels(pageviews_ts$type))) {
    
    if (j > 7) {
      
    modified_ts$dailycount[modified_ts$type[i]][j] <- ((pageviews_ts[j] -  pageviews_ts[j-7])/pageviews_ts[j-7])*100
    
    } else {
      
      modified_ts$dailycount[modified_ts$type[i]][j] <- "NA"
      
    }
  }
}

```

# Peaks-Over-Threshold

Is the model suitable here for each time series 
