---
title: "Practical 3: Web Traffic"
author: "Colin Steffe, Virany Kho, Jasmine Mawjee, Adela Sahraoui"
date: "11/25/2021"
output: html_document
---

```{r data preparation, echo=F, message=F, warning=F}

library(here)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(fpp3)
library(ggthemes)

options(scipen=999)

# Read in the data
load(file = here::here("traffic.Rdata"))

# Convert into tibble 
pageviews <- as_tibble(pageviews)

# Create new column
type <- c("Elizabeth_II", 
          "United_States",
          "Queen_Victoria",
          "World_War_II",
          "World_War_I",
          "George_VI",
          "United_Kingdom",
          "Princess_Margaret,_Countess_of_Snowdon",
          "Prince_Philip,_Duke_of_Edinburgh",
          "Winston_Churchill",
          "Diana,_Princess_of_Wales",
          "2016_Summer_Olympics")

# Add new column
pageviews <- cbind(pageviews,
                   type)

# Reorder colum
pageviews <- pageviews[, c(804, 1:803)]

# Pivot data frame 
pageviews <- pageviews %>% 
             pivot_longer(!type, 
                          names_to = "date", 
                          values_to = "dailycount")

# Convert column date into date format
pageviews$date <- as.Date(pageviews$date, format = "%Y-%m-%d")

# Convert into tsibble
pageviews_ts <- tsibble(pageviews, 
                        index = date,
                        key = c(type, dailycount)) %>% # since duplicates need to keys         
                arrange(type, date)

# str(pageviews_ts) # to verify the structure of dataframe

```

# Informative Plots

## Time Series

Since we do not see a trend, we understand that the time series are stationary (i.e. depend on the time of the observation). 

The plot below does not seem to detail a specific seasonal trend and pattern. Therefore, the search pattern of these topics is not related to the time of the year. However, we can see that in certain times of the year there are some large peaks, and the majority seem to be linked to the British Royal family. These peaks could be due to independent events occurring, such as the well-being of the Queen or the arrival of the TV series the Crown that could spark interest in people's searches in regards to the royal family. We can also see that the Summer Olympic searches are high around the time of it happening or building up to the event. However, once the Olympic games ended, the searches fall drastically, as to be expected.

```{r time series plot, echo=F, message=F, warning=F}

library(plotly)

ts_plot <- pageviews_ts %>%
           ggplot(mapping = aes(x = date, 
                                y = dailycount,
                                colour = factor(type))) +
           geom_line() +
  
           labs(title = "Web Traffic: Daily Count",
                x = "Time of Occurrence [1D]", 
                y = "Daily count",
                fill = type)  #+
  
           #theme_economist_white() # we can change the theme for something cooler ? 

ggplotly(ts_plot) %>% 
  config(displayModeBar = T) 
  
```
## Bar plot

We have made a bar plot depicting the frequency of views and searches on a given topic/type.

```{r bar plot, echo=F, message=F, warning=F}

a <- pageviews_ts %>% 
  ggplot() + 
  geom_histogram(aes(x = dailycount, fill=type), na.rm = TRUE) + 
  geom_vline(xintercept = mean (pageviews_ts$dailycount, na.rm = TRUE)) + labs(y="frequency")

library(plotly)
ggplotly(a)
         
```

# Modified Series

$$
R_i = \frac{X_i - X_{i-7}}{X_{i-7}} * 100
$$
$R_i$ is the relative weekly change (increase or decrease) in percentage.

```{r modified time series, echo=F, message=F, warning=F}

# pour chaque "type" on crée une time series modifiée "modified_ts" pour lesquelles on recalcules la valeur de daily count en utilisant la formule du dessus. etant donné qu'on a - Xi-7 on peut que commencer à calculer pour la 8ème observation de chaque time series (1 par type)

type <- as.factor(type)

# Create a modified time series using the initial one
modified_ts <- pageviews_ts
ind <- 1
    
for (i in levels(type)) {
  
  subset_type <- pageviews_ts %>%
                 filter(type == i)
    
  for (j in 1:nrow(subset_type)) {
    
    if (j > 7) {
      
    modified_ts$dailycount[[ind]] <- ((subset_type$dailycount[[j]] -  subset_type$dailycount[[j-7]])/subset_type$dailycount[[j-7]])*100
    
    } else {
      
      modified_ts$dailycount[[ind]] <- NA
      
    }
    
    ind <- ind + 1
  }
}

modified_ts <- rename(modified_ts, 
                      "daily count modified" = "dailycount")

```

When plotting the relative weekly change we see the highs and lows more clearly. There is a massive high load in the traffic count April 2016 for Princess Margaret and another big but smaller peak for Winston Churchill in February 2016. 

```{r modified time series plot, echo=F, message=F, warning=F}

modifiedts_plot <- modified_ts %>%
                   ggplot(mapping = aes(x = date, 
                                        y = `daily count modified`,
                                        colour = factor(type))) +
                   geom_line() +
  
                   labs(title = "Modified Time Series: Web Traffic",
                        x = "Time of Occurrence [1D]", 
                        y = "Modified Daily count (%)",
                        fill = type)  +
          
                   theme_economist_white() # we can change the theme for something cooler ? 

ggplotly(modifiedts_plot) %>% 
  config(displayModeBar = T) # can we add the woom opt on the x axis ? 
  


```

```{r full data, echo=F, message=F, warning=F}

# Binding the modified daily count to have everything in the same place
ts <- bind_cols(pageviews_ts, modified_ts) 

ts <- inner_join(pageviews_ts, modified_ts, by = c("type","date"))

ts <- ts %>%
      arrange(type, date)

```

# Peaks-Over-Threshold {.tabset}

For each time series ($R_i,\ i = 1, ..., 12$), we plot their daily count distribution on a **Q-Q plot** to assess if their data come from a theoretical distribution (e.g. Normal). Using the qq draws the correlation between a given sample and the normal distribution. The *geom_line(..., distribution = stats::qqnorm)* function visually checks the normality assumption of the distribution. If the assumption does not hold, we look into how/what data points contribute to the violation. 

Results: on all below Q-Q plots, we observe that the daily count distributions follow a normal distribution when in the bulk of the distribution but departs from when in the tail indicating that the data is skewed. Indeed, it is right-skewed (i.e. positively skewed). 

Knowing that the data is right-skewed we generate the time series' **Mean Residual Plot** using the *mrlplot()* function from the *extRemes* package which plots the potential thresholds against the mean excess. The following plots are used to choose the most adequate thresholds. Indeed, the value of $u$ from which the plot becomes approximately linear can generally be selected as the optimal threshold. 

After setting their theoretical optimal threshold, we plot their **Peaks-Over-Threshold Plot** with their threshold $u$ to display the exceedences. Note that if a threshold is too low then the extreme value approach cannot be valid and that if it is too high we cannot obtain insightful results because of too few data.

For the following modified time series where the POT is not suitable, we suggest using a Block Maxima approach. 

### Elizabeth II {.tabset}

#### Distribution

```{r, echo=F, message=F, warning=F}

# qqplot by types ( two ways)

 ts_type <- ts %>% 
   filter(type == "Elizabeth_II") 
 
  ggplot(data = ts_type, aes(sample = `daily count modified`)) + 
  geom_qq(color = "pink", distribution = stats::qnorm) +
  geom_qq_line(color = "dark green") +
  labs(y = "Daily Count",
       )

```

#### Mean Residual Plot

The selected threshold $u$ is 125.

```{r, echo=F, message=F, warning=F}

 ts_type <- ts %>% 
            filter(type == "Elizabeth_II") 
 
 ts_type <- ts_type %>% 
            filter(!is.na(`daily count modified`))
 
  # Mean Residual Life Plot (MRLP)
  extRemes::mrlplot(ts_type$`daily count modified`,
                    main = "Mean Residual Life Plot: Mean Excess Function for Elizabeth_II")


```

#### Peaks-Over-Threshold Plot

The chosen threshold indicates that there are not too few data points exceeding the threshold nor to many. Therefore, we assume that using the POT model is suitable. 

```{r, echo=F, warning=F, message=F}

 ts_type <- ts %>% 
            filter(type == "Elizabeth_II") 
 
 ts_type <- ts_type %>% 
            filter(!is.na(`daily count modified`))

 plot(x = rep(1:nrow(ts_type), 
                    each = 1), 
            y = unlist(ts_type$`daily count modified`), 
            main = paste("Peak-Over-Threshold plot Exceedances for Elizabeth II"),
            sub = paste("threshold =", 125), 
            xlab = "Observations", 
            ylab = "Threshold") 
 
 pot_points <- unlist(ts_type$`daily count modified`) > 125

 points(x = rep(1:nrow(ts_type), each = 1)[pot_points], 
       y = unlist(ts_type$`daily count modified`)[pot_points], 
       col = "red")

 abline(abline(h = 125, col = "red"))

```


### United States {.tabset}

#### Distribution

```{r, echo=F, message=F, warning=F}

# qqplot by types ( two ways)

 ts_type <- ts %>% 
   filter(type == "United_States") 
 
  ggplot(data = ts_type, aes(sample = `daily count modified`)) + 
  geom_qq(color = "pink") +
  geom_qq_line(color = "dark green") +
  labs(y = "Daily Count")

```

#### Mean Residual Plot

The selected threshold $u$ is 35.

```{r, echo=F, message=F, warning=F}

 ts_type <- ts %>% 
            filter(type == "United_States") 
 
 ts_type <- ts_type %>% 
            filter(!is.na(`daily count modified`))
 
  # Mean Residual Life Plot (MRLP)
  extRemes::mrlplot(ts_type$`daily count modified`,
                    main = "Mean Residual Life Plot: Mean Excess Function for United_States")

```

#### Peaks-Over-Threshold Plot

The chosen threshold indicates that there are few data points exceeding the threshold. Therefore, we believe that using the POT model is maybe not suitable. 

```{r, echo=F, warning=F, message=F}

 ts_type <- ts %>% 
   filter(type == "United_States") 
 
 ts_type <- ts_type %>% 
   filter(!is.na(`daily count modified`))

 plot(x = rep(1:nrow(ts_type), 
                    each = 1), 
            y = unlist(ts_type$`daily count modified`), 
            main = paste("Peak-Over-Threshold plot Exceedances for United States"),
            sub = paste("threshold =", 35), 
            xlab = "Observations", 
            ylab = "Threshold") 
 
 pot_points <- unlist(ts_type$`daily count modified`) > 35

 points(x = rep(1:nrow(ts_type), each = 1)[pot_points], 
       y = unlist(ts_type$`daily count modified`)[pot_points], 
       col = "red")

 
 abline(abline(h = 35, col = "red"))

```

### Queen Victoria {.tabset}

#### Distribution

```{r, echo=F, message=F, warning=F}

# qqplot by types ( two ways)

 ts_type <- ts %>% 
   filter(type == "Queen_Victoria") 
 
  ggplot(data = ts_type, aes(sample = `daily count modified`)) + 
  geom_qq(color = "pink") +
  geom_qq_line(color = "dark green") +
  labs(y = "Daily Count")

```

#### Mean Residual Plot 

The selected threshold $u$ is 100.

```{r, echo=F, message=F, warning=F}

 ts_type <- ts %>% 
            filter(type == "Queen_Victoria") 
 
 ts_type <- ts_type %>% 
            filter(!is.na(`daily count modified`))
 
  # Mean Residual Life Plot (MRLP)
  extRemes::mrlplot(ts_type$`daily count modified`,
                    main = "Mean Residual Life Plot: Mean Excess Function for Queen_Victoria")

```

#### Peaks-Over-Threshold Plot

The chosen threshold indicates that there are not too few nor too many data points exceeding the threshold. Therefore, we assume that using the POT model is suitable. 

```{r, echo=F, warning=F, message=F}

 ts_type <- ts %>% 
   filter(type == "Queen_Victoria") 
 
 ts_type <- ts_type %>% 
   filter(!is.na(`daily count modified`))

 plot(x = rep(1:nrow(ts_type), 
                    each = 1), 
            y = unlist(ts_type$`daily count modified`), 
            main = paste("Peak-Over-Threshold plot Exceedances for Queen Victoria"),
            sub = paste("threshold =", 100), 
            xlab = "Observations", 
            ylab = "Threshold") 
 
 pot_points <- unlist(ts_type$`daily count modified`) > 100

 points(x = rep(1:nrow(ts_type), each = 1)[pot_points], 
       y = unlist(ts_type$`daily count modified`)[pot_points], 
       col = "red")

 
 abline(abline(h = 100, col = "red"))

```

### World War II {.tabset}

#### Distribution

```{r, echo=F, message=F, warning=F}

# qqplot by types ( two ways)

 ts_type <- ts %>% 
   filter(type == "World_War_II") 
 
  ggplot(data = ts_type, aes(sample = `daily count modified`)) + 
  geom_qq(color = "pink") +
  geom_qq_line(color = "dark green") +
  labs(y = "Daily Count")

```

#### Mean Residual Plot

The selected threshold $u$ is 30.

```{r, echo=F, message=F, warning=F}

 ts_type <- ts %>% 
            filter(type == "World_War_II") 
 
 ts_type <- ts_type %>% 
            filter(!is.na(`daily count modified`))
 
  # Mean Residual Life Plot (MRLP)
  extRemes::mrlplot(ts_type$`daily count modified`,
                    main = "Mean Residual Life Plot: Mean Excess Function for World_War_II")

```

#### Peaks-Over-Threshold Plot

The chosen threshold indicates that there are not too few nor too many data points exceeding the threshold. Therefore, we assume that using the POT model is suitable. 

```{r, echo=F, warning=F, message=F}

 ts_type <- ts %>% 
            filter(type == "World_War_II") 
 
 ts_type <- ts_type %>% 
            filter(!is.na(`daily count modified`))

 plot(x = rep(1:nrow(ts_type), 
                    each = 1), 
            y = unlist(ts_type$`daily count modified`), 
            main = paste("Peak-Over-Threshold plot Exceedances for World War II"),
            sub = paste("threshold =", 30), 
            xlab = "Observations", 
            ylab = "Threshold") 
 
 pot_points <- unlist(ts_type$`daily count modified`) > 30

 points(x = rep(1:nrow(ts_type), each = 1)[pot_points], 
       y = unlist(ts_type$`daily count modified`)[pot_points], 
       col = "red")

 
 abline(abline(h = 30, col = "red"))

```

### World War I {.tabset}

#### Distribution

```{r, echo=F, message=F, warning=F}

# qqplot by types ( two ways)

 ts_type <- ts %>% 
   filter(type == "World_War_I") 
 
  ggplot(data = ts_type, aes(sample = `daily count modified`)) + 
  geom_qq(color = "pink") +
  geom_qq_line(color = "dark green") +
  labs(y = "Daily Count")

```

#### Mean Residual Plot

The selected threshold $u$ is 25.

```{r, echo=F, message=F, warning=F}

 ts_type <- ts %>% 
            filter(type == "World_War_I") 
 
 ts_type <- ts_type %>% 
            filter(!is.na(`daily count modified`))
 
  # Mean Residual Life Plot (MRLP)
  extRemes::mrlplot(ts_type$`daily count modified`,
                    main = "Mean Residual Life Plot: Mean Excess Function for World_War_I")

```

#### Peaks-Over-Threshold Plot

The chosen threshold indicates that there are not too few nor too many data points exceeding the threshold. Therefore, we assume that using the POT model is suitable. 

```{r, echo=F, warning=F, message=F}

 ts_type <- ts %>% 
   filter(type == "World_War_I") 
 
 ts_type <- ts_type %>% 
   filter(!is.na(`daily count modified`))

 plot(x = rep(1:nrow(ts_type), 
                    each = 1), 
            y = unlist(ts_type$`daily count modified`), 
            main = paste("Peak-Over-Threshold plot Exceedances for World War I"),
            sub = paste("threshold =", 25), 
            xlab = "Observations", 
            ylab = "Threshold") 
 
 pot_points <- unlist(ts_type$`daily count modified`) > 25

 points(x = rep(1:nrow(ts_type), each = 1)[pot_points], 
       y = unlist(ts_type$`daily count modified`)[pot_points], 
       col = "red")

 
 abline(abline(h = 25, col = "red"))

```

### George VI {.tabset}

#### Distribution

```{r, echo=F, message=F, warning=F}

# qqplot by types ( two ways)

 ts_type <- ts %>% 
   filter(type == "George_VI") 
 
  ggplot(data = ts_type, aes(sample = `daily count modified`)) + 
  geom_qq(color = "pink") +
  geom_qq_line(color = "dark green") +
  labs(y = "Daily Count")

```

#### Mean Residual Plot

The selected threshold $u$ is 200.

```{r, echo=F, message=F, warning=F}

 ts_type <- ts %>% 
            filter(type == "George_VI") 
 
 ts_type <- ts_type %>% 
            filter(!is.na(`daily count modified`))
 
  # Mean Residual Life Plot (MRLP)
  extRemes::mrlplot(ts_type$`daily count modified`,
                    main = "Mean Residual Life Plot: Mean Excess Function for George_VI")

```

#### Peaks-Over-Threshold Plot

The chosen threshold indicates that there are too few data points exceeding the threshold. Therefore, we believe that using the POT model is maybe not suitable. 

```{r, echo=F, warning=F, message=F}

 ts_type <- ts %>% 
   filter(type == "George_VI") 
 
 ts_type <- ts_type %>% 
   filter(!is.na(`daily count modified`))

 plot(x = rep(1:nrow(ts_type), 
                    each = 1), 
            y = unlist(ts_type$`daily count modified`), 
            main = paste("Peak-Over-Threshold plot Exceedances for George VI"),
            sub = paste("threshold =", 200), 
            xlab = "Observations", 
            ylab = "Threshold") 
 
 pot_points <- unlist(ts_type$`daily count modified`) > 200

 points(x = rep(1:nrow(ts_type), each = 1)[pot_points], 
       y = unlist(ts_type$`daily count modified`)[pot_points], 
       col = "red")

 
 abline(abline(h = 200, col = "red"))

```

### United Kingdom {.tabset}

#### Distribution

```{r, echo=F, message=F, warning=F}

# qqplot by types ( two ways)

 ts_type <- ts %>% 
            filter(type == "United_Kingdom") 
 
  ggplot(data = ts_type, aes(sample = `daily count modified`)) + 
  geom_qq(color = "pink") +
  geom_qq_line(color = "dark green") +
  labs(y = "Daily Count")

```

#### Mean Residual Plot

The selected threshold $u$ is 50.

```{r, echo=F, message=F, warning=F}

 ts_type <- ts %>% 
            filter(type == "United_Kingdom") 
 
 ts_type <- ts_type %>% 
            filter(!is.na(`daily count modified`))
 
  # Mean Residual Life Plot (MRLP)
  extRemes::mrlplot(ts_type$`daily count modified`,
                    main = "Mean Residual Life Plot: Mean Excess Function for United_Kingdom")

```

#### Peaks-Over-Threshold Plot

The chosen threshold indicates that there are too few data points exceeding the threshold. Therefore, we believe that using the POT model is maybe not suitable.

```{r, echo=F, warning=F, message=F}

 ts_type <- ts %>% 
            filter(type == "United_Kingdom") 
 
 ts_type <- ts_type %>% 
            filter(!is.na(`daily count modified`))

 plot(x = rep(1:nrow(ts_type), 
                    each = 1), 
            y = unlist(ts_type$`daily count modified`), 
            main = paste("Peak-Over-Threshold plot Exceedances for United_Kingdom"),
            sub = paste("threshold =", 50), 
            xlab = "Observations", 
            ylab = "Threshold") 
 
 pot_points <- unlist(ts_type$`daily count modified`) > 50

 points(x = rep(1:nrow(ts_type), each = 1)[pot_points], 
       y = unlist(ts_type$`daily count modified`)[pot_points], 
       col = "red")

 
 abline(abline(h = 50, col = "red"))

```

### Princess Margaret, Countess of Snowdon {.tabset}

#### Distribution

```{r, echo=F, message=F, warning=F}

# qqplot by types ( two ways)

 ts_type <- ts %>% 
            filter(type == "Princess_Margaret,_Countess_of_Snowdon") 
 
  ggplot(data = ts_type, aes(sample = `daily count modified`)) + 
  geom_qq(color = "pink") +
  geom_qq_line(color = "dark green") +
  labs(y = "Daily Count")

```

#### Mean Residual Plot

The selected threshold $u$ is 700.

```{r, echo=F, message=F, warning=F}

 ts_type <- ts %>% 
            filter(type == "Princess_Margaret,_Countess_of_Snowdon") 
 
 ts_type <- ts_type %>% 
            filter(!is.na(`daily count modified`))
 
  # Mean Residual Life Plot (MRLP)
  extRemes::mrlplot(ts_type$`daily count modified`,
                    main = "Mean Residual Life Plot: Mean Excess Function for Princess_Margaret,_Countess_of_Snowdon")

```

#### Peaks-Over-Threshold Plot

The chosen threshold indicates that there are too few data points exceeding the threshold. Therefore, we believe that using the POT model is maybe not suitable.

```{r, echo=F, warning=F, message=F}

 ts_type <- ts %>% 
            filter(type == "Princess_Margaret,_Countess_of_Snowdon") 
 
 ts_type <- ts_type %>% 
   filter(!is.na(`daily count modified`))

 plot(x = rep(1:nrow(ts_type), 
                    each = 1), 
            y = unlist(ts_type$`daily count modified`), 
            main = paste("Peak-Over-Threshold plot Exceedances for Princess Margaret, Countess of Snowdon"),
            sub = paste("threshold =", 700), 
            xlab = "Observations", 
            ylab = "Threshold") 
 
 pot_points <- unlist(ts_type$`daily count modified`) > 700

 points(x = rep(1:nrow(ts_type), each = 1)[pot_points], 
       y = unlist(ts_type$`daily count modified`)[pot_points], 
       col = "red")

 abline(abline(h = 700, col = "red"))

```

### Prince Philip, Duke of Edinburgh {.tabset}

#### Distribution

```{r, echo=F, message=F, warning=F}

# qqplot by types ( two ways)

 ts_type <- ts %>% 
            filter(type == "Prince_Philip,_Duke_of_Edinburgh") 
 
  ggplot(data = ts_type, aes(sample = `daily count modified`)) + 
  geom_qq(color = "pink") +
  geom_qq_line(color = "dark green") +
  labs(y = "Daily Count")

```

#### Mean Residual Plot

The selected threshold $u$ is 400.

```{r, echo=F, message=F, warning=F}

 ts_type <- ts %>% 
            filter(type == "Prince_Philip,_Duke_of_Edinburgh") 
 
 ts_type <- ts_type %>% 
            filter(!is.na(`daily count modified`))
 
  # Mean Residual Life Plot (MRLP)
  extRemes::mrlplot(ts_type$`daily count modified`,
                    main = "Mean Residual Life Plot: Mean Excess Function for Prince_Philip,_Duke_of_Edinburgh")

```

#### Peaks-Over-Threshold Plot

The chosen threshold indicates that there are too few data points exceeding the threshold. Therefore, we believe that using the POT model is maybe not suitable.

```{r, echo=F, warning=F, message=F}

 ts_type <- ts %>% 
            filter(type == "Prince_Philip,_Duke_of_Edinburgh") 
 
 ts_type <- ts_type %>% 
            filter(!is.na(`daily count modified`))

 plot(x = rep(1:nrow(ts_type), 
                    each = 1), 
            y = unlist(ts_type$`daily count modified`), 
            main = "Peak-Over-Threshold plot Exceedances for Prince Philip, Duke of Edinburgh",
            sub = paste("threshold =", 400), 
            xlab = "Observations", 
            ylab = "Threshold") 
 
 pot_points <- unlist(ts_type$`daily count modified`) > 400

 points(x = rep(1:nrow(ts_type), each = 1)[pot_points], 
       y = unlist(ts_type$`daily count modified`)[pot_points], 
       col = "red")

 
 abline(abline(h = 400, col = "red"))

```

### Winston Churchill {.tabset}

#### Distribution

```{r, echo=F, message=F, warning=F}

# qqplot by types ( two ways)

 ts_type <- ts %>% 
   filter(type == "Winston_Churchill") 
 
  ggplot(data = ts_type, aes(sample = `daily count modified`)) + 
  geom_qq(color = "pink") +
  geom_qq_line(color = "dark green") +
  labs(y = "Daily Count")

```

#### Mean Residual Plot

The selected threshold $u$ is 100.

```{r, echo=F, message=F, warning=F}

 ts_type <- ts %>% 
            filter(type == "Winston_Churchill") 
 
 ts_type <- ts_type %>% 
            filter(!is.na(`daily count modified`))
 
  # Mean Residual Life Plot (MRLP)
  extRemes::mrlplot(ts_type$`daily count modified`,
                    main = "Mean Residual Life Plot: Mean Excess Function for Winston_Churchill")

```

#### Peaks-Over-Threshold Plot

The chosen threshold indicates that there are too few data points exceeding the threshold. Therefore, we believe that using the POT model is maybe not suitable.

```{r, echo=F, warning=F, message=F}

 ts_type <- ts %>% 
            filter(type == "Winston_Churchill") 
 
 ts_type <- ts_type %>% 
            filter(!is.na(`daily count modified`))

 plot(x = rep(1:nrow(ts_type), 
                    each = 1), 
            y = unlist(ts_type$`daily count modified`), 
            main = paste("Peak-Over-Threshold plot Exceedances for Winston Churchill"),
            sub = paste("threshold =", 100), 
            xlab = "Observations", 
            ylab = "Threshold") 
 
 pot_points <- unlist(ts_type$`daily count modified`) > 100

 points(x = rep(1:nrow(ts_type), each = 1)[pot_points], 
       y = unlist(ts_type$`daily count modified`)[pot_points], 
       col = "red")

 
 abline(abline(h = 100, col = "red"))

```

### Diana, Princess of Wales {.tabset}

#### Distribution

```{r, echo=F, message=F, warning=F}

# qqplot by types ( two ways)

 ts_type <- ts %>% 
            filter(type == "Diana,_Princess_of_Wales") 
 
  ggplot(data = ts_type, aes(sample = `daily count modified`)) + 
  geom_qq(color = "pink") +
  geom_qq_line(color = "dark green") +
  labs(y = "Daily Count")

```

#### Mean Residual Plot

The selected threshold $u$ is 70.

```{r, echo=F, message=F, warning=F}

 ts_type <- ts %>% 
            filter(type == "Diana,_Princess_of_Wales") 
 
 ts_type <- ts_type %>% 
            filter(!is.na(`daily count modified`))
 
  # Mean Residual Life Plot (MRLP)
  extRemes::mrlplot(ts_type$`daily count modified`,
                    main = "Mean Residual Life Plot: Mean Excess Function for Diana,_Princess_of_Wales")

```

#### Peaks-Over-Threshold Plot

The chosen threshold indicates that there are not too few nor to many data points exceeding the threshold. Therefore, we assume that using the POT model is suitable.

```{r, echo=F, warning=F, message=F}

 ts_type <- ts %>% 
            filter(type == "Diana,_Princess_of_Wales") 
 
 ts_type <- ts_type %>% 
            filter(!is.na(`daily count modified`))

 plot(x = rep(1:nrow(ts_type), 
                    each = 1), 
            y = unlist(ts_type$`daily count modified`), 
            main = paste("Peak-Over-Threshold plot Exceedances for Diana, Princess of Wales"),
            sub = paste("threshold =", 70), 
            xlab = "Observations", 
            ylab = "Threshold") 
 
 pot_points <- unlist(ts_type$`daily count modified`) > 70

 points(x = rep(1:nrow(ts_type), each = 1)[pot_points], 
       y = unlist(ts_type$`daily count modified`)[pot_points], 
       col = "red")

 abline(abline(h = 70, col = "red"))

```

### 2016 Summer Olympics {.tabset}

#### Distribution

```{r, echo=F, message=F, warning=F}

# qqplot by types ( two ways)

 ts_type <- ts %>% 
            filter(type == "2016_Summer_Olympics") 
 
  ggplot(data = ts_type, aes(sample = `daily count modified`)) + 
  geom_qq(color = "pink") +
  geom_qq_line(color = "dark green") +
  labs(y = "Daily Count")

```

#### Mean Residual Plot

The selected threshold $u$ is 60.

```{r, echo=F, message=F, warning=F}

 ts_type <- ts %>% 
            filter(type == "2016_Summer_Olympics") 
 
 ts_type <- ts_type %>% 
            filter(!is.na(`daily count modified`))
 
  # Mean Residual Life Plot (MRLP)
  extRemes::mrlplot(ts_type$`daily count modified`,
                    main = "Mean Residual Life Plot: Mean Excess Function for 2016_Summer_Olympics")

```

#### Peaks-Over-Threshold Plot

The chosen threshold indicates that there are too few data points exceeding the threshold. Therefore, we believe that using the POT model is maybe not suitable.

```{r, echo=F, warning=F, message=F}

 ts_type <- ts %>% 
            filter(type == "2016_Summer_Olympics") 
 
 ts_type <- ts_type %>% 
            filter(!is.na(`daily count modified`))

 plot(x = rep(1:nrow(ts_type), 
                    each = 1), 
            y = unlist(ts_type$`daily count modified`), 
            main = paste("Peak-Over-Threshold plot Exceedances for 2016 Summer Olympics"),
            sub = paste("threshold =", 60), 
            xlab = "Observations", 
            ylab = "Threshold") 
 
 pot_points <- unlist(ts_type$`daily count modified`) > 60

 points(x = rep(1:nrow(ts_type), each = 1)[pot_points], 
       y = unlist(ts_type$`daily count modified`)[pot_points], 
       col = "red")

 abline(abline(h = 60, col = "red"))

```

## 99-Quantile

The following outcome shows the 99%-quantile and uncertainty measures of the modified daily count modified for each time series. To generate these results we use the *quantile* function of the *stats* package and the standard error of the peaks-over-threshold model. 

```{r, echo=F, message=F, warning=F}

library(evd)

# data frame for the 99 quantile and measure of uncertainty for all the type
thresholds <- c(60, 70, 125, 200, 100, 700, 100, 50, 35, 100, 25, 30)
data99 <- data.frame(matrix(0, nrow = 2, ncol = length(unique(ts$type))))
colnames(data99) <- unique(ts$type)
rownames(data99) <- c("quantile99","uncertainty")

for (i in 1:ncol(data99)){

  # filter for the type
   ts_type <- ts %>% 
   filter(type == names(data99)[i]) 
 
   # remove na
 ts_type <- ts_type %>% 
   filter(!is.na(`daily count modified`))
 
 # compute 99 quantile
 quantile99 <- quantile(ts_type$`daily count modified` , 0.99)
 
 # save the quantile in the data.frame
 data99[1,i] <- quantile99 
 
 # measure of uncertainty
 
 # not sure about the mper argument
 # doc of the function here : https://www.rdocumentation.org/packages/evd/versions/2.3-3/topics/fpot
 uncertainty <- fpot(ts_type$`daily count modified`, threshold = thresholds[i], mper = quantile99)
 
 # not sure if we need to save the r level or shape
 data99[2,i] <- uncertainty$std.err[1]
}

data99

```

# Detecting Simultaneous High Load

## Graphical Method

The graphical method that we suggest for detecting simultaneous high traffic loads is a Block Maxima interactive plot colored by topic. This allows to visually see the daily maxima between the 12 different web pages. If for one or several days that display high maxima but also other value from other webpages that are just below, it indicates a simultaneous high load. 

By pointing the mouse cursor over data points, more information is available. With this plot, we can observe that Princess Margret, Georges IV, and Prince Philip of Edinburgh have the largest simultaneous high loads around 2016 November 6, but also have another smaller simultaneous high loads in 2016 April 21. So the idea for Wikipedia is that if one of these web pages load is increasing they should do caching on the other ones to prevent exhausting of available resources.

Another alternative method would be to generate scatter plots to visualize how two distributions move together. 

```{r, echo=F, message=F, warning=F}

library(extRemes)
# idea for graphical representation : block maxima by week colored by type
# https://rdrr.io/cran/extRemes/man/blockmaxxer.html
tsnona <- ts%>% filter(!is.na(`daily count modified`))

# compute block maxima
bm <- blockmaxxer(tsnona, blocks = tsnona$date, which="daily count modified")

library(plotly)

c <-ggplot(tsnona, aes(x=date, y=`daily count modified`)) + 
  geom_point(aes(color = type)) + 
  geom_point(data = bm, aes(date,`daily count modified`, fill = type),
             colour = "lightpink1") 

ggplotly(c)

```

## Numerical Method

For the numerical method, we compute a matrix of the tail dependence coefficients between the different web pages. We are interested in the values that are the closest to 1. They indicate that there is a high likelihood that if an extreme value in the tail arises for one web page, the other webpage is very likely to also display an extreme value in its high tail. Therefore, there is tail dependence and there is probably going to show a simultaneous high load for both (or more than two) pages. In this case, Wikipedia must anticipate and use the caching system on them. 

Here, we use the *tdc* function form the *FRAPO* package. 

```{r, echo=F, message=F, warning=F}

library(FRAPO)
modified_NoNA <- modified_ts %>% drop_na

modified_pivot <- modified_NoNA %>% pivot_wider(values_from =`daily count modified`, names_from = type,date)

tdc(modified_pivot[,-1], method = "EVT") %>% knitr::kable()

```

