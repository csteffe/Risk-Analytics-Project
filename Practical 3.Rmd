---
title: "Practical 3: Web Traffic"
author: "Colin Steffe, Virany Kho, Jasmine Mawjee, Adela Sahraoui"
date: "11/25/2021"
output: html_document
---

```{r data preparation, echo=F, message=F, warning=F}

library(here)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(fpp3)
library(ggthemes)

options(scipen=999)

# Read in the data
load(file = here::here("traffic.Rdata"))

# Convert into tibble 
pageviews <- as_tibble(pageviews)

# Create new column
type <- c("Elizabeth_II", 
          "United_States",
          "Queen_Victoria",
          "World_War_II",
          "World_War_I",
          "George_VI",
          "United_Kingdom",
          "Princess_Margaret,_Countess_of_Snowdon",
          "Prince_Philip,_Duke_of_Edinburgh",
          "Winston_Churchill",
          "Diana,_Princess_of_Wales",
          "2016_Summer_Olympics")

# Add new column
pageviews <- cbind(pageviews,
                   type)

# Reorder colum
pageviews <- pageviews[, c(804, 1:803)]

# Pivot data frame 
pageviews <- pageviews %>% 
             pivot_longer(!type, 
                          names_to = "date", 
                          values_to = "dailycount")

# Convert column date into date format
pageviews$date <- as.Date(pageviews$date, format = "%Y-%m-%d")

# Convert into tsibble
pageviews_ts <- tsibble(pageviews, 
                        index = date,
                        key = c(type, dailycount)) %>% # since duplicates need to keys         
                arrange(type, date)

# str(pageviews_ts) # to verify the structure of dataframe

```

# Informative Plots

## Time Series

If we see a trend, the time series is not stationary (i.e. does not depend on the time of the observation). 

```{r time series plot, echo=F, message=F, warning=F}

library(plotly)

ts_plot <- pageviews_ts %>%
           ggplot(mapping = aes(x = date, 
                                y = dailycount,
                                colour = factor(type))) +
           geom_line() +
  
           labs(title = "Web Traffic: Daily Count",
                x = "Time of Occurrence [1D]", 
                y = "Daily count",
                fill = type)  #+
  
           #theme_economist_white() # we can change the theme for something cooler ? 

ggplotly(ts_plot) %>% 
  config(displayModeBar = T) 
  
```
## Bar plot

```{r bar plot, echo=F, message=F, warning=F}

pageviews_ts %>% 
  ggplot() + 
  geom_histogram(aes(x = dailycount), na.rm = TRUE) + 
  geom_vline(xintercept = mean (pageviews_ts$dailycount, na.rm = TRUE))
         
```

# Modified Series

$$
R_i = \frac{X_i - X_{i-7}}{X_{i-7}} * 100
$$
$R_i$ is the relative weekly change (increase or decrease) in percentage.

```{r modified time series, echo=F, message=F, warning=F}

# pour chaque "type" on crée une time series modifiée "modified_ts" pour lesquelles on recalcules la valeur de daily count en utilisant la formule du dessus. etant donné qu'on a - Xi-7 on peut que commencer à calculer pour la 8ème observation de chaque time series (1 par type)

type <- as.factor(type)

# Create a modified time series using the initial one
modified_ts <- pageviews_ts
ind <- 1
    
for (i in levels(type)) {
  
  subset_type <- pageviews_ts %>%
                 filter(type == i)
    
  for (j in 1:nrow(subset_type)) {
    
    if (j > 7) {
      
    modified_ts$dailycount[[ind]] <- ((subset_type$dailycount[[j]] -  subset_type$dailycount[[j-7]])/subset_type$dailycount[[j-7]])*100
    
    } else {
      
      modified_ts$dailycount[[ind]] <- NA
      
    }
    
    ind <- ind + 1
  }
}

modified_ts <- rename(modified_ts, 
                      "daily count modified" = "dailycount")

```

```{r modified time series plot, echo=F, message=F, warning=F}

modifiedts_plot <- modified_ts %>%
                   ggplot(mapping = aes(x = date, 
                                        y = `daily count modified`,
                                        colour = factor(type))) +
                   geom_line() +
  
                   labs(title = "Modified Time Series: Web Traffic",
                        x = "Time of Occurrence [1D]", 
                        y = "Modified Daily count (%)",
                        fill = type)  +
          
                   theme_economist_white() # we can change the theme for something cooler ? 

ggplotly(modifiedts_plot) %>% 
  config(displayModeBar = T) # can we add the woom opt on the x axis ? 
  


```

```{r full data, echo=F, message=F, warning=F}

# Binding the modified daily count to have everything in the same place
ts <- bind_cols(pageviews_ts, modified_ts) 

ts <- inner_join(pageviews_ts, modified_ts, by = c("type","date"))

ts <- ts %>%
      arrange(type, date)

```

# Peaks-Over-Threshold {.tabset}

1) Examine the suitability for each time series $R_i$ separately:

2)  Explain your choice of threshold and briefly comment on the diagnostic plots for each model: 

* **Mean Residual Plot**: The following plots are used to choose the most adequate thresholds. Ideed, the value of $u$ from which the plot becomes approximately linear can generally be selected as the optimal threshold

## Elizabeth II {.tabset}

### Distribution

```{r, echo=F, message=F, warning=F}

# qqplot by types ( two ways)

 ts_type <- ts %>% 
   filter(type == "Elizabeth_II") 
 
  ggplot(data = ts_type, aes(sample = `daily count modified`)) + 
  geom_qq(color = "pink") +
  geom_qq_line(color = "dark green") +
  labs(y = "Daily Count")

```

### Mean Residual Plot

The selected threshold $u$ is 125.

```{r, echo=F, message=F, warning=F}

 ts_type <- ts %>% 
            filter(type == "Elizabeth_II") 
 
 ts_type <- ts_type %>% 
            filter(!is.na(`daily count modified`))
 
  # Mean Residual Life Plot (MRLP)
  extRemes::mrlplot(ts_type$`daily count modified`,
                    main = "Mean Residual Life Plot: Mean Excess Function for Elizabeth_II")


```

### Peaks-Over-Threshold Plot

```{r, echo=F, warning=F, message=F}

 ts_type <- ts %>% 
            filter(type == "Elizabeth_II") 
 
 ts_type <- ts_type %>% 
            filter(!is.na(`daily count modified`))

 plot(x = rep(1:nrow(ts_type), 
                    each = 1), 
            y = unlist(ts_type$`daily count modified`), 
            main = paste("Peak-Over-Threshold plot Exceedances for Elizabeth II"),
            sub = paste("threshold =", 125), 
            xlab = "Observations", 
            ylab = "Threshold") 
 
 pot_points <- unlist(ts_type$`daily count modified`) > 125

 points(x = rep(1:nrow(ts_type), each = 1)[pot_points], 
       y = unlist(ts_type$`daily count modified`)[pot_points], 
       col = "red")

 abline(abline(h = 125, col = "red"))

```


## United States {.tabset}

### Distribution

```{r, echo=F, message=F, warning=F}

# qqplot by types ( two ways)

 ts_type <- ts %>% 
   filter(type == "United_States") 
 
  ggplot(data = ts_type, aes(sample = `daily count modified`)) + 
  geom_qq(color = "pink") +
  geom_qq_line(color = "dark green") +
  labs(y = "Daily Count")

```

### Mean Residual Plot

The selected threshold $u$ is 35.

```{r, echo=F, message=F, warning=F}

 ts_type <- ts %>% 
            filter(type == "United_States") 
 
 ts_type <- ts_type %>% 
            filter(!is.na(`daily count modified`))
 
  # Mean Residual Life Plot (MRLP)
  extRemes::mrlplot(ts_type$`daily count modified`,
                    main = "Mean Residual Life Plot: Mean Excess Function for United_States")

```

### Peaks-Over-Threshold Plot

```{r, echo=F, warning=F, message=F}

 ts_type <- ts %>% 
   filter(type == "United_States") 
 
 ts_type <- ts_type %>% 
   filter(!is.na(`daily count modified`))

 plot(x = rep(1:nrow(ts_type), 
                    each = 1), 
            y = unlist(ts_type$`daily count modified`), 
            main = paste("Peak-Over-Threshold plot Exceedances for United States"),
            sub = paste("threshold =", 35), 
            xlab = "Observations", 
            ylab = "Threshold") 
 
 pot_points <- unlist(ts_type$`daily count modified`) > 35

 points(x = rep(1:nrow(ts_type), each = 1)[pot_points], 
       y = unlist(ts_type$`daily count modified`)[pot_points], 
       col = "red")

 
 abline(abline(h = 35, col = "red"))

```

## Queen Victoria {.tabset}

### Distribution

```{r, echo=F, message=F, warning=F}

# qqplot by types ( two ways)

 ts_type <- ts %>% 
   filter(type == "Queen_Victoria") 
 
  ggplot(data = ts_type, aes(sample = `daily count modified`)) + 
  geom_qq(color = "pink") +
  geom_qq_line(color = "dark green") +
  labs(y = "Daily Count")

```

### Mean Residual Plot 

The selected threshold $u$ is 100.

```{r, echo=F, message=F, warning=F}

 ts_type <- ts %>% 
            filter(type == "Queen_Victoria") 
 
 ts_type <- ts_type %>% 
            filter(!is.na(`daily count modified`))
 
  # Mean Residual Life Plot (MRLP)
  extRemes::mrlplot(ts_type$`daily count modified`,
                    main = "Mean Residual Life Plot: Mean Excess Function for Queen_Victoria")

```

### Peaks-Over-Threshold Plot

```{r, echo=F, warning=F, message=F}

 ts_type <- ts %>% 
   filter(type == "Queen_Victoria") 
 
 ts_type <- ts_type %>% 
   filter(!is.na(`daily count modified`))

 plot(x = rep(1:nrow(ts_type), 
                    each = 1), 
            y = unlist(ts_type$`daily count modified`), 
            main = paste("Peak-Over-Threshold plot Exceedances for Queen Victoria"),
            sub = paste("threshold =", 100), 
            xlab = "Observations", 
            ylab = "Threshold") 
 
 pot_points <- unlist(ts_type$`daily count modified`) > 100

 points(x = rep(1:nrow(ts_type), each = 1)[pot_points], 
       y = unlist(ts_type$`daily count modified`)[pot_points], 
       col = "red")

 
 abline(abline(h = 100, col = "red"))

```

## World War II {.tabset}

### Distribution

```{r, echo=F, message=F, warning=F}

# qqplot by types ( two ways)

 ts_type <- ts %>% 
   filter(type == "World_War_II") 
 
  ggplot(data = ts_type, aes(sample = `daily count modified`)) + 
  geom_qq(color = "pink") +
  geom_qq_line(color = "dark green") +
  labs(y = "Daily Count")

```

### Mean Residual Plot

The selected threshold $u$ is 30.

```{r, echo=F, message=F, warning=F}

 ts_type <- ts %>% 
            filter(type == "World_War_II") 
 
 ts_type <- ts_type %>% 
            filter(!is.na(`daily count modified`))
 
  # Mean Residual Life Plot (MRLP)
  extRemes::mrlplot(ts_type$`daily count modified`,
                    main = "Mean Residual Life Plot: Mean Excess Function for World_War_II")

```

### Peaks-Over-Threshold Plot

```{r, echo=F, warning=F, message=F}

 ts_type <- ts %>% 
            filter(type == "World_War_II") 
 
 ts_type <- ts_type %>% 
            filter(!is.na(`daily count modified`))

 plot(x = rep(1:nrow(ts_type), 
                    each = 1), 
            y = unlist(ts_type$`daily count modified`), 
            main = paste("Peak-Over-Threshold plot Exceedances for World War II"),
            sub = paste("threshold =", 30), 
            xlab = "Observations", 
            ylab = "Threshold") 
 
 pot_points <- unlist(ts_type$`daily count modified`) > 30

 points(x = rep(1:nrow(ts_type), each = 1)[pot_points], 
       y = unlist(ts_type$`daily count modified`)[pot_points], 
       col = "red")

 
 abline(abline(h = 30, col = "red"))

```

## World War I {.tabset}

### Distribution

```{r, echo=F, message=F, warning=F}

# qqplot by types ( two ways)

 ts_type <- ts %>% 
   filter(type == "World_War_I") 
 
  ggplot(data = ts_type, aes(sample = `daily count modified`)) + 
  geom_qq(color = "pink") +
  geom_qq_line(color = "dark green") +
  labs(y = "Daily Count")

```

### Mean Residual Plot

The selected threshold $u$ is 25.

```{r, echo=F, message=F, warning=F}

 ts_type <- ts %>% 
            filter(type == "World_War_I") 
 
 ts_type <- ts_type %>% 
            filter(!is.na(`daily count modified`))
 
  # Mean Residual Life Plot (MRLP)
  extRemes::mrlplot(ts_type$`daily count modified`,
                    main = "Mean Residual Life Plot: Mean Excess Function for World_War_I")

```

### Peaks-Over-Threshold Plot

```{r, echo=F, warning=F, message=F}

 ts_type <- ts %>% 
   filter(type == "World_War_I") 
 
 ts_type <- ts_type %>% 
   filter(!is.na(`daily count modified`))

 plot(x = rep(1:nrow(ts_type), 
                    each = 1), 
            y = unlist(ts_type$`daily count modified`), 
            main = paste("Peak-Over-Threshold plot Exceedances for World War I"),
            sub = paste("threshold =", 25), 
            xlab = "Observations", 
            ylab = "Threshold") 
 
 pot_points <- unlist(ts_type$`daily count modified`) > 25

 points(x = rep(1:nrow(ts_type), each = 1)[pot_points], 
       y = unlist(ts_type$`daily count modified`)[pot_points], 
       col = "red")

 
 abline(abline(h = 25, col = "red"))

```

## George VI {.tabset}

### Distribution

```{r, echo=F, message=F, warning=F}

# qqplot by types ( two ways)

 ts_type <- ts %>% 
   filter(type == "George_VI") 
 
  ggplot(data = ts_type, aes(sample = `daily count modified`)) + 
  geom_qq(color = "pink") +
  geom_qq_line(color = "dark green") +
  labs(y = "Daily Count")

```

### Mean Residual Plot

The selected threshold $u$ is 200.

```{r, echo=F, message=F, warning=F}

 ts_type <- ts %>% 
            filter(type == "George_VI") 
 
 ts_type <- ts_type %>% 
            filter(!is.na(`daily count modified`))
 
  # Mean Residual Life Plot (MRLP)
  extRemes::mrlplot(ts_type$`daily count modified`,
                    main = "Mean Residual Life Plot: Mean Excess Function for George_VI")

```

### Peaks-Over-Threshold Plot

```{r, echo=F, warning=F, message=F}

 ts_type <- ts %>% 
   filter(type == "George_VI") 
 
 ts_type <- ts_type %>% 
   filter(!is.na(`daily count modified`))

 plot(x = rep(1:nrow(ts_type), 
                    each = 1), 
            y = unlist(ts_type$`daily count modified`), 
            main = paste("Peak-Over-Threshold plot Exceedances for George VI"),
            sub = paste("threshold =", 200), 
            xlab = "Observations", 
            ylab = "Threshold") 
 
 pot_points <- unlist(ts_type$`daily count modified`) > 200

 points(x = rep(1:nrow(ts_type), each = 1)[pot_points], 
       y = unlist(ts_type$`daily count modified`)[pot_points], 
       col = "red")

 
 abline(abline(h = 200, col = "red"))

```

## United Kingdom {.tabset}

### Distribution

```{r, echo=F, message=F, warning=F}

# qqplot by types ( two ways)

 ts_type <- ts %>% 
            filter(type == "United_Kingdom") 
 
  ggplot(data = ts_type, aes(sample = `daily count modified`)) + 
  geom_qq(color = "pink") +
  geom_qq_line(color = "dark green") +
  labs(y = "Daily Count")

```

### Mean Residual Plot

The selected threshold $u$ is 50.

```{r, echo=F, message=F, warning=F}

 ts_type <- ts %>% 
            filter(type == "United_Kingdom") 
 
 ts_type <- ts_type %>% 
            filter(!is.na(`daily count modified`))
 
  # Mean Residual Life Plot (MRLP)
  extRemes::mrlplot(ts_type$`daily count modified`,
                    main = "Mean Residual Life Plot: Mean Excess Function for United_Kingdom")

```

### Peaks-Over-Threshold Plot

```{r, echo=F, warning=F, message=F}

 ts_type <- ts %>% 
            filter(type == "United_Kingdom") 
 
 ts_type <- ts_type %>% 
            filter(!is.na(`daily count modified`))

 plot(x = rep(1:nrow(ts_type), 
                    each = 1), 
            y = unlist(ts_type$`daily count modified`), 
            main = paste("Peak-Over-Threshold plot Exceedances for United_Kingdom"),
            sub = paste("threshold =", 50), 
            xlab = "Observations", 
            ylab = "Threshold") 
 
 pot_points <- unlist(ts_type$`daily count modified`) > 50

 points(x = rep(1:nrow(ts_type), each = 1)[pot_points], 
       y = unlist(ts_type$`daily count modified`)[pot_points], 
       col = "red")

 
 abline(abline(h = 50, col = "red"))

```

## Princess Margaret, Countess of Snowdon {.tabset}

### Distribution

```{r, echo=F, message=F, warning=F}

# qqplot by types ( two ways)

 ts_type <- ts %>% 
            filter(type == "Princess_Margaret,_Countess_of_Snowdon") 
 
  ggplot(data = ts_type, aes(sample = `daily count modified`)) + 
  geom_qq(color = "pink") +
  geom_qq_line(color = "dark green") +
  labs(y = "Daily Count")

```

### Mean Residual Plot

The selected threshold $u$ is 700.

```{r, echo=F, message=F, warning=F}

 ts_type <- ts %>% 
            filter(type == "Princess_Margaret,_Countess_of_Snowdon") 
 
 ts_type <- ts_type %>% 
            filter(!is.na(`daily count modified`))
 
  # Mean Residual Life Plot (MRLP)
  extRemes::mrlplot(ts_type$`daily count modified`,
                    main = "Mean Residual Life Plot: Mean Excess Function for Princess_Margaret,_Countess_of_Snowdon")

```

### Peaks-Over-Threshold Plot

```{r, echo=F, warning=F, message=F}

 ts_type <- ts %>% 
            filter(type == "Princess_Margaret,_Countess_of_Snowdon") 
 
 ts_type <- ts_type %>% 
   filter(!is.na(`daily count modified`))

 plot(x = rep(1:nrow(ts_type), 
                    each = 1), 
            y = unlist(ts_type$`daily count modified`), 
            main = paste("Peak-Over-Threshold plot Exceedances for Princess Margaret, Countess of Snowdon"),
            sub = paste("threshold =", 700), 
            xlab = "Observations", 
            ylab = "Threshold") 
 
 pot_points <- unlist(ts_type$`daily count modified`) > 700

 points(x = rep(1:nrow(ts_type), each = 1)[pot_points], 
       y = unlist(ts_type$`daily count modified`)[pot_points], 
       col = "red")

 abline(abline(h = 700, col = "red"))

```

## Prince Philip, Duke of Edinburgh {.tabset}

### Distribution

```{r, echo=F, message=F, warning=F}

# qqplot by types ( two ways)

 ts_type <- ts %>% 
            filter(type == "Prince_Philip,_Duke_of_Edinburgh") 
 
  ggplot(data = ts_type, aes(sample = `daily count modified`)) + 
  geom_qq(color = "pink") +
  geom_qq_line(color = "dark green") +
  labs(y = "Daily Count")

```

### Mean Residual Plot

The selected threshold $u$ is 100.

```{r, echo=F, message=F, warning=F}

 ts_type <- ts %>% 
            filter(type == "Prince_Philip,_Duke_of_Edinburgh") 
 
 ts_type <- ts_type %>% 
            filter(!is.na(`daily count modified`))
 
  # Mean Residual Life Plot (MRLP)
  extRemes::mrlplot(ts_type$`daily count modified`,
                    main = "Mean Residual Life Plot: Mean Excess Function for Prince_Philip,_Duke_of_Edinburgh")

```

### Peaks-Over-Threshold Plot

```{r, echo=F, warning=F, message=F}

 ts_type <- ts %>% 
            filter(type == "Prince_Philip,_Duke_of_Edinburgh") 
 
 ts_type <- ts_type %>% 
            filter(!is.na(`daily count modified`))

 plot(x = rep(1:nrow(ts_type), 
                    each = 1), 
            y = unlist(ts_type$`daily count modified`), 
            main = "Peak-Over-Threshold plot Exceedances for Prince Philip, Duke of Edinburgh",
            sub = paste("threshold =", 700), 
            xlab = "Observations", 
            ylab = "Threshold") 
 
 pot_points <- unlist(ts_type$`daily count modified`) > 700

 points(x = rep(1:nrow(ts_type), each = 1)[pot_points], 
       y = unlist(ts_type$`daily count modified`)[pot_points], 
       col = "red")

 
 abline(abline(h = 700, col = "red"))

```

## Winston Churchill {.tabset}

### Distribution

```{r, echo=F, message=F, warning=F}

# qqplot by types ( two ways)

 ts_type <- ts %>% 
   filter(type == "Winston_Churchill") 
 
  ggplot(data = ts_type, aes(sample = `daily count modified`)) + 
  geom_qq(color = "pink") +
  geom_qq_line(color = "dark green") +
  labs(y = "Daily Count")

```

### Mean Residual Plot

The selected threshold $u$ is 100.

```{r, echo=F, message=F, warning=F}

 ts_type <- ts %>% 
            filter(type == "Winston_Churchill") 
 
 ts_type <- ts_type %>% 
            filter(!is.na(`daily count modified`))
 
  # Mean Residual Life Plot (MRLP)
  extRemes::mrlplot(ts_type$`daily count modified`,
                    main = "Mean Residual Life Plot: Mean Excess Function for Winston_Churchill")

```

### Peaks-Over-Threshold Plot

```{r, echo=F, warning=F, message=F}

 ts_type <- ts %>% 
            filter(type == "Winston_Churchill") 
 
 ts_type <- ts_type %>% 
            filter(!is.na(`daily count modified`))

 plot(x = rep(1:nrow(ts_type), 
                    each = 1), 
            y = unlist(ts_type$`daily count modified`), 
            main = paste("Peak-Over-Threshold plot Exceedances for Winston Churchill"),
            sub = paste("threshold =", 100), 
            xlab = "Observations", 
            ylab = "Threshold") 
 
 pot_points <- unlist(ts_type$`daily count modified`) > 100

 points(x = rep(1:nrow(ts_type), each = 1)[pot_points], 
       y = unlist(ts_type$`daily count modified`)[pot_points], 
       col = "red")

 
 abline(abline(h = 100, col = "red"))

```

## Diana, Princess of Wales {.tabset}

### Distribution

```{r, echo=F, message=F, warning=F}

# qqplot by types ( two ways)

 ts_type <- ts %>% 
            filter(type == "Diana,_Princess_of_Wales") 
 
  ggplot(data = ts_type, aes(sample = `daily count modified`)) + 
  geom_qq(color = "pink") +
  geom_qq_line(color = "dark green") +
  labs(y = "Daily Count")

```

### Mean Residual Plot

The selected threshold $u$ is 70.

```{r, echo=F, message=F, warning=F}

 ts_type <- ts %>% 
            filter(type == "Diana,_Princess_of_Wales") 
 
 ts_type <- ts_type %>% 
            filter(!is.na(`daily count modified`))
 
  # Mean Residual Life Plot (MRLP)
  extRemes::mrlplot(ts_type$`daily count modified`,
                    main = "Mean Residual Life Plot: Mean Excess Function for Diana,_Princess_of_Wales")

```

### Peaks-Over-Threshold Plot

```{r, echo=F, warning=F, message=F}

 ts_type <- ts %>% 
            filter(type == "Diana,_Princess_of_Wales") 
 
 ts_type <- ts_type %>% 
            filter(!is.na(`daily count modified`))

 plot(x = rep(1:nrow(ts_type), 
                    each = 1), 
            y = unlist(ts_type$`daily count modified`), 
            main = paste("Peak-Over-Threshold plot Exceedances for Diana, Princess of Wales"),
            sub = paste("threshold =", 70), 
            xlab = "Observations", 
            ylab = "Threshold") 
 
 pot_points <- unlist(ts_type$`daily count modified`) > 70

 points(x = rep(1:nrow(ts_type), each = 1)[pot_points], 
       y = unlist(ts_type$`daily count modified`)[pot_points], 
       col = "red")

 abline(abline(h = 70, col = "red"))

```

## 2016 Summer Olympics {.tabset}

### Distribution

```{r, echo=F, message=F, warning=F}

# qqplot by types ( two ways)

 ts_type <- ts %>% 
            filter(type == "2016_Summer_Olympics") 
 
  ggplot(data = ts_type, aes(sample = `daily count modified`)) + 
  geom_qq(color = "pink") +
  geom_qq_line(color = "dark green") +
  labs(y = "Daily Count")

```

### Mean Residual Plot

The selected threshold $u$ is 60.

```{r, echo=F, message=F, warning=F}

 ts_type <- ts %>% 
            filter(type == "2016_Summer_Olympics") 
 
 ts_type <- ts_type %>% 
            filter(!is.na(`daily count modified`))
 
  # Mean Residual Life Plot (MRLP)
  extRemes::mrlplot(ts_type$`daily count modified`,
                    main = "Mean Residual Life Plot: Mean Excess Function for 2016_Summer_Olympics")

```

### Peaks-Over-Threshold Plot

```{r, echo=F, warning=F, message=F}

 ts_type <- ts %>% 
            filter(type == "2016_Summer_Olympics") 
 
 ts_type <- ts_type %>% 
            filter(!is.na(`daily count modified`))

 plot(x = rep(1:nrow(ts_type), 
                    each = 1), 
            y = unlist(ts_type$`daily count modified`), 
            main = paste("Peak-Over-Threshold plot Exceedances for 2016 Summer Olympics"),
            sub = paste("threshold =", 60), 
            xlab = "Observations", 
            ylab = "Threshold") 
 
 pot_points <- unlist(ts_type$`daily count modified`) > 60

 points(x = rep(1:nrow(ts_type), each = 1)[pot_points], 
       y = unlist(ts_type$`daily count modified`)[pot_points], 
       col = "red")

 abline(abline(h = 60, col = "red"))

```

Suitability of POT:
- Princess Margaret, United Kingdom, United States (?), Wiston Churchill do not seem to be suitable for POT because of the too few numbers of exceedances.

* Estimate the 99%-quantile of each series and give a corresponding measure of uncertainty = provide an interval of values within which the true value  of the threshol is believed to lie with a stated probability (MSE ? with confidence interval ?)

```{r, echo=F, message=F, warning=F}

library(evd)

# data frame for the 99 quantile and measure of uncertainty for all the type
thresholds <- c(60, 70, 125, 200, 100, 700, 100, 50, 35, 100, 25, 30)
data99 <- data.frame(matrix(0, nrow = 2, ncol = length(unique(ts$type))))
colnames(data99) <- unique(ts$type)
rownames(data99) <- c("quantile99","uncertainty")

for (i in 1:ncol(data99)){

  # filter for the type
   ts_type <- ts %>% 
   filter(type == names(data99)[i]) 
 
   # remove na
 ts_type <- ts_type %>% 
   filter(!is.na(`daily count modified`))
 
 # compute 99 quantile
 quantile99 <- quantile(ts_type$`daily count modified` , 0.99)
 
 # save the quantile in the data.frame
 data99[1,i] <- quantile99 
 
 # measure of uncertainty
 
 # not sure about the mper argument
 # doc of the function here : https://www.rdocumentation.org/packages/evd/versions/2.3-3/topics/fpot
 uncertainty <- fpot(ts_type$`daily count modified`, threshold = thresholds[i], mper = quantile99)
 
 # not sure if we need to save the r level or shape
 data99[2,i] <- uncertainty$std.err[1]
}

data99

```

# Detecting Simultaneous High Load

## Graphical Method

```{r, echo=F, message=F, warning=F}

library(extRemes)
# idea for graphical representation : block maxima by week colored by type
# https://rdrr.io/cran/extRemes/man/blockmaxxer.html
tsnona <- ts%>% filter(!is.na(`daily count modified`))

# compute block maxima
bm <- blockmaxxer(tsnona, blocks = tsnona$date, which="daily count modified")

library(plotly)

c <-ggplot(tsnona, aes(x=date, y=`daily count modified`)) + 
  geom_point(aes(color = type)) + 
  geom_point(data = bm, aes(date,`daily count modified`, fill = type),
             colour = "lightpink1") 

ggplotly(c)

```

## Numerical Method

```{r, echo=F, message=F, warning=F}

library(FRAPO)
modified_NoNA <- modified_ts %>% drop_na

modified_pivot <- modified_NoNA %>% pivot_wider(values_from =`daily count modified`, names_from = type,date)

tdc(modified_pivot[,-1], method = "EVT") %>% knitr::kable()

```

