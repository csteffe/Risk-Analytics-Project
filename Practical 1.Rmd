---
title: "Practical 1: High Water Levels"
author: "Colin Steffe, Virany Kho, Jasmine Mawjee, Adela Sahraoui"
output: html_document
---

```{r upload data, echo=F, warning=F, message=F}

library(here)

# Read in the data
load(file = here::here("niveau.Rdata"))

```

# Data

The next table displays the first six rows of the *niveau* data set. 

The data set collects the Aare's daily maximum water levels in one unique station in Stilli, Untersiggenthal (canton of Aargau) and records the exact times at which daily maximal values are detected. 

```{r tsibble, echo=F, warning=F, message=F}

library(lubridate)
library(tibble)
library(tsibble)
library(fpp3)
library(kableExtra)

# Convert column 8 into date type
niveau <- niveau %>%
          mutate(Zeitpunkt_des_Auftretens = as_datetime(Zeitpunkt_des_Auftretens))
#niveau$Zeitpunkt_des_Auftretens[1]

# Transform into tibble
niveau.ts <- niveau %>%
             as_tsibble(index = Zeitpunkt_des_Auftretens,
                        key = Zeitstempel)

head(niveau.ts, 6) %>%
  kbl(align = c('c', 'c', 'c', 'c', 'c', 'c', 'c', 'c', 'c', 'c')) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), 
                full_width = F)  

```

# Time Series: Water Levels

The below plot shows the evolution of water levels over 21 years from 01-01-2000 to 01-08-2021. 

First, we observe a pattern indicating that water levels fluctuate a lot within a year (i.e. seasonality?). Second, we see that the lowest troughs are quite constant over the years (~325.5 meter above sea) whereas the highest peaks really distinguish themselves among the overall peaks. Indeed, we observe that peaks are mainly observed in the Summer months with the highest peaks recorded on 25-08-2005 at 328.827 [meter above sea], on 09-06-2007 at 329.323 [meter above sea] and on 14-07-2021 at 328.622 [meter above sea]. Therefore, over 21 years three years have had extremely and unusually high water levels during the summer, respectively 2005, 2007 and 2021. 

```{r time series, echo=F, warning=F, message=F}

library(plotly)

# Plot the time series
time_series <- niveau.ts %>% 
  ggplot() + 
  geom_line(mapping = aes(x = Zeitpunkt_des_Auftretens, 
                          y = Wert)) +
  
  labs(title = "Time Series: Water Levels",
       subtitle = "Daily maximal value",
       caption = "source: niveau.Rdata",
       x = "Time of Occurrence [1D]",
       y = "Value [meter above sea]") 

ggplotly(time_series) %>% config(displayModeBar = F)

```

# Value Distribution

The following output shows the five-number statistics summary of the water level values. 

The summary shows that the water level values are not symmetrical around the mean or the median but much more tightly grouped on the lefts side of the mean (and the median) than on its right side (i.e. more dispersed), indicating that the water levels' distribution is right-skewed. The second observation is that the difference between the minimum and maximum water level is not very large. 

```{r summary, echo=F, warning=F, message=F}

summary(niveau.ts$Wert)

```

The below histogram (i.e. frequency distribution) confirms the above observations. Indeed, we see that the data is right-skewed (i.e. therefore non-normal) indicating that the data is disproportionately distributed on the right where water levels happen to have much higher values than usual (i.e. outliers) that need to be investigated.     

The red curve represents the smoothed version of the histogram which reflects more accurately the probability density function of the values. The purple vertical line draws the median water level value, 325.8 meter above sea, and the green vertical line draws the average, 325.9. [ADD THE MODE]

Looking at the positions on the x-axis of the mean and the median [and the mode] with regard to the distribution, we see that the mean seems to be a better indicator of the center of the distribution. [adapt interpretation when mode is on].

[IMPROVE GRAPH: better color/theme + add legend ]

```{r histogram, echo=F, warning=F, message=F}

# Histogram
niveau.ts %>% 
  ggplot() + 
  geom_histogram(mapping = aes(Wert),
                 stat = "count") +
  
  # Adds smoothed version of the histogram
  geom_density(mapping = aes(Wert), stat = "density", colour = "red") + 
  
  # Adds the mode
  #geom_vline(xintercept = mode(niveau.ts$Wert),       
             #col = "blue",
             #lwd = 1) +
  
  # Adds the mean
  geom_vline(xintercept = mean(niveau.ts$Wert),       
             col = "green",
             lwd = 1) +
  
  # Adds the median
  geom_vline(xintercept = median(niveau.ts$Wert),       
             col = "purple",
             lwd = 1) +

  labs(title = "Water Levels Frequencies",
       x = "Water Level Value [meter above sea]",
       y = "Frequency") +
  
  # Adds legend
  theme(legend.position="right")

```

# Risk Assessment

- [peaks-over-threshold method]
The Peaks-over-Threshold method identifies extreme values that are above a designated threshold u. In order to determine an optimal threshold we will apply the MRL-plot and then look at the distribution of the data points. The value of u above which the plot is approximately linear can generally be selected as the optimal threshold. So,this is what we are going to do to model the high water levels: first we will make a MRL-plot to choose the optimal threshold and then use the Peak-over-Threshold method.

- [clustering of the extremes]
Clusters of the extremes correspond to the clustering of the data points that are above the chosen threshold u.
Consecutive threshold exceedances are considered to belong to the same cluster.
In our case, concerning the daily water levels data, by using the Peak-over-Threshold approach we can observe thanks to the plot the different clusters of the extreme values, then we can fit the Generalized Pareto Distribution (GPD) or Point Process Model to the cluster maxima (after declustering if the exceedances exhibit autocorrrelation).

- [drawbacks and advantages of using block maxima method instead ]


### Analysis

```{r extremes, echo=F, warning=F, message=F}

# Plot mean residual life (MRL)
library(extRemes)
extRemes::mrlplot(niveau.ts$Wert)

```

The threshold could be put at around 326 or 327.

```{r peak-over-threshold, echo=F, warning=F, message=F}

threshold <- 327 # 327 as Threshold looks better than 326

# Plot of Peak-over-Threshold
plot(x = rep(1:7883, each = 1), y = unlist(niveau.ts$Wert), main = "Peak Over Thresholds",
     sub = paste("threshold =", threshold), xlab = "series", ylab = "value")
pot_points <- unlist(niveau.ts$Wert) > threshold
points(x = rep(1:7883, each = 1)[pot_points], y = unlist(niveau.ts$Wert)[pot_points], col = "red")
abline(h = threshold, col = "red")

```

Decluster 
```{r}
decluster <- decluster(niveau$Wert, threshold = 327)
summary(decluster)
plot(decluster)
```

Log return

```{r}
ret <- diff(log(niveau.ts$Wert))


plot(niveau.ts$Zeitpunkt_des_Auftretens[-1],100*ret,type="l",main = "log return over time",xlab="Time",ylab="log return in %",col=1)
points(niveau.ts$Zeitpunkt_des_Auftretens[-1],100*ret,col=2,cex=0.1)
```


### GPD: 1st way of using Peak-over-Threshold data
```{r}
# GPD: 1st way of using Peak-over-Threshold data
gpd <- fevd(unlist(niveau.ts$Wert), threshold = threshold, type = "GP")
plot(gpd, type = "density", main = "Empirical POT vs estimated GPD")

```


### Return Level with GDP
```{r}
# Plot of the Return Level
plot(gpd, type = "rl", main = "Return level")

```


### Point Process Model: 2nd way of using Peak-over-Threshold data
```{r}
pt_pro <- fevd(unlist(niveau.ts$Wert), threshold = threshold, type = "PP")
plot(pt_pro, type = "density", main = "Empirical POT vs Point Process")

```


### Return Level with Point Process Level
```{r}
# Plot of the Return Level
plot(pt_pro, type = "rl", main = "Return level")
```

### 50-Year Events

### 100-Year Events
