---
title: "Practical 1: High Water Levels"
author: "Colin Steffe, Virany Kho, Jasmine Mawjee, Adela Sahraoui"
output: html_document
---

```{r upload data, echo=F, warning=F, message=F}

# Read in the data
load(file = here::here("niveau.Rdata"))

```

```{r tsibble, echo=F, warning=F, message=F}

library(lubridate)
library(tibble)
library(tsibble)
library(fpp3)

# Convert column 8 into date type
niveau <- niveau %>%
          mutate(Zeitpunkt_des_Auftretens = as_datetime(Zeitpunkt_des_Auftretens))
#niveau$Zeitpunkt_des_Auftretens[1]

# Transform into tibble
niveau.ts <- niveau %>%
             as_tsibble(index = Zeitpunkt_des_Auftretens,
                        key = Zeitstempel)

```

## Time Series: Water Levels

The below plot shows the evolution of water levels over 21 years from 01-01-2000 to 01-08-2021. 

First, we observe a pattern indicating that water levels fluctuate a lot (i.e. large difference between peaks and troughs) in a year (i.e. seasonality?). Moreover, we observe that the highest peaks were mainly observed in the Summer months with the highest peaks recorded on 09-06-2007 at 329.323 [add unit of measurement], on 25-08-2005 at 328.827 [add unit] and on 14-07-2021 at 328.622 [add unit]. 

```{r time series, echo=F, warning=F, message=F}

library(plotly)

# Plot the time series
time_series <- niveau.ts %>% 
  ggplot() + 
  geom_line(mapping = aes(x = Zeitpunkt_des_Auftretens, 
                          y = Wert)) +
  
  labs(title = "Time Series: Water Levels",
       x = "Time of Occurrence",
       y = "Value") 

ggplotly(time_series) %>% config(displayModeBar = F)

```

## Value Distribution

The below output shows the five-number statistics summary of the water level values. We immediately understand that the values are not symmetrical around the mean but much more tightly grouped on the lefts side of the mean (and the median) than on its right side, indicating that the water level values's distribution is right-skewed. 

```{r summary, echo=F, warning=F, message=F}

summary(niveau.ts$Wert)

```

The below histogram (i.e. frequency distribution) confirms the above observations. Indeed, we see that the data is right-skewed (i.e. non-normal) indicating that the data is disproportionally distributed on the right where water level outliers need to be investigated.     

On top of the histogram we add a red curve being the smoothed version of the histogram showing again the shape of the distribution, a purple line indicating the median water level value (value that splits the observation in half) and the average water level in green. 

Looking at the positions on the x-axis of the mean and the median [add mode at some point], we see that the mean seems to be a better indication of the center of the distribution. [adapt interpretation when mode is on].

```{r histogram, echo=F, warning=F, message=F}

# Histogram
niveau.ts %>% 
  ggplot() + 
  geom_histogram(mapping = aes(Wert),
                 stat = "count") +
  
  # Adds smoothed version of the histogram
  geom_density(mapping = aes(Wert), stat = "density", colour = "red") + 
  
  # Adds the mode
  #geom_vline(xintercept = mode(niveau.ts$Wert),       
             #col = "blue",
             #lwd = 1) +
  
  # Adds the mean
  geom_vline(xintercept = mean(niveau.ts$Wert),       
             col = "green",
             lwd = 1) +
  
  # Adds the median
  geom_vline(xintercept = median(niveau.ts$Wert),       
             col = "purple",
             lwd = 1) +

  labs(title = "Water Levels Frequencies",
       x = "Value",
       y = "Frequency")

```

## Risk Assessment

- [peaks-over-threshold method]
The Peaks-over-Threshold method identifies extreme values that are above a designated threshold u. In order to determine an optimal threshold we will apply the MRL-plot and then look at the distribution of the data points. The value of u above which the plot is approximately linear can generally be selected as the optimal threshold. So,this is what we are going to do to model the high water levels: first we will make a MRL-plot to choose the optimal threshold and then use the Peak-over-Threshold method.

- [clustering of the extremes]
Clusters of the extremes correspond to the clustering of the data points that are above the chosen threshold u.
Consecutive threshold exceedances are considered to belong to the same cluster.
In our case, concerning the daily water levels data, by using the Peak-over-Threshold approach we can observe thanks to the plot the different clusters of the extreme values, then we can fit the Generalized Pareto Distribution (GPD) to the cluster maxima (after declustering if the exceedances exhibit autocorrrelation).

- [drawbacks and advantages of using block maxima method instead ]


### Analysis

```{r extremes, echo=F, warning=F, message=F}

# Plot mean residual life (MRL)
library(extRemes)
extRemes::mrlplot(niveau.ts$Wert)

```

The threshold could be put at around 326 or 327.

```{r peak-over-threshold, echo=F, warning=F, message=F}

threshold <- 327 # 327 as Threshold looks better than 326

# Plot of Peak-over-Threshold
plot(x = rep(1:7883, each = 1), y = unlist(niveau.ts$Wert), main = "Peak Over Thresholds",
     sub = paste("threshold =", threshold), xlab = "series", ylab = "value")
pot_points <- unlist(niveau.ts$Wert) > threshold
points(x = rep(1:7883, each = 1)[pot_points], y = unlist(niveau.ts$Wert)[pot_points], col = "red")
abline(h = threshold, col = "red")

```


### 50-Year Events

### 100-Year Events
