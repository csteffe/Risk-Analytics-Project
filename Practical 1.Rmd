---
title: "Practical 1: High Water Levels"
author: "Colin Steffe, Virany Kho, Jasmine Mawjee, Adela Sahraoui"
output: html_document
---

```{r upload data, echo=F, warning=F, message=F}

library(here)

# Read in the data
load(file = here::here("niveau.Rdata"))

```

# Data

The next table displays the first six rows of the *niveau* data set. 

The data set collects the Aare's daily maximum water levels in one unique station in Stilli, Untersiggenthal (canton of Aargau) and records the exact times at which daily maximal values are detected. 

```{r tsibble, echo=F, warning=F, message=F}

library(lubridate)
library(tibble)
library(tsibble)
library(fpp3)
library(kableExtra)

# Convert column 8 into date type
niveau <- niveau %>%
          mutate(Zeitpunkt_des_Auftretens = as_datetime(Zeitpunkt_des_Auftretens))
#niveau$Zeitpunkt_des_Auftretens[1]

# Transform into tibble
niveau.ts <- niveau %>%
             as_tsibble(index = Zeitpunkt_des_Auftretens,
                        key = Zeitstempel)

head(niveau.ts, 6) %>%
  kbl(align = c('c', 'c', 'c', 'c', 'c', 'c', 'c', 'c', 'c', 'c')) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), 
                full_width = F)  

```

# Time Series: 

The below plot shows the evolution of water levels over 21 years from 01-01-2000 to 01-08-2021. 

We see that the lowest troughs are quite constant over the years (~325.5 meter above sea level) whereas the highest peaks really distinguish themselves among the overall peaks. [SHOULD WE THEN REMOVE THE WEIRD THREE VALUES ?] Indeed, we observe that peaks are mainly observed in the Summer months with the highest peaks recorded on 25-08-2005 at 328.827 (m.a.s.l), on 09-06-2007 at 329.323 (m.a.s.l) and on 14-07-2021 at 328.622 (m.a.s.l). Therefore, over 21 years three years have had extremely and unusually high water levels during the summer, respectively 2005, 2007 and 2021. 

We also observe a pattern of the maxima shown by the green smoothed curve which indicates that water levels fluctuate according to a specific logic within a year (i.e. trend and seasonality?). [How can we assess an homogeneity issue because of a trend ?]

```{r time series, echo=F, warning=F, message=F}

library(plotly)

# Plot the time series
time_series <- niveau.ts %>% 
  ggplot(mapping = aes(x = Zeitpunkt_des_Auftretens, 
                       y = Wert)) + 
  geom_line() +
  
  # Add the smoothed trend
  stat_smooth(color = "green") +
  
  labs(title = "Daily Maximum Water Levels (m.a.s.l) in Stilli",
       caption = "source: niveau.Rdata", # [the caption doesn't appear !!!]
       x = "Time of Occurrence [1D]", 
       y = "Water Level Values [m.a.s.l]") 

ggplotly(time_series) %>% 
  config(displayModeBar = F)

```

# Daily Water Level Maxima Distribution

The following output shows the five-number statistics summary of the water level values. 

The summary shows that the water level values are not symmetrical around the mean or the median but much more tightly grouped on the lefts side of the mean (and the median) than on its right side (i.e. more dispersed), indicating that the water levels' distribution is right-skewed. The second observation is that the difference between the minimum and maximum water level is not very large. 

```{r summary, echo=F, warning=F, message=F}

summary(niveau.ts$Wert)

```

The below histogram (i.e. frequency distribution) confirms the above observations. Indeed, we see that the data is right-skewed (i.e. therefore non-normal) indicating that the data is disproportionately distributed on the right where water levels happen to have much higher values than usual (i.e. outliers) that need to be investigated.     

The red curve represents the smoothed version of the histogram which reflects more accurately the probability density function of the values. The purple vertical line draws the median water level value, 325.8 meter above sea, and the green vertical line draws the average, 325.9. [ADD THE MODE]

Looking at the positions on the x-axis of the mean and the median [and the mode] with regard to the distribution, we see that the mean seems to be a better indicator of the center of the distribution. [adapt interpretation when mode is on].

[IMPROVE GRAPH: better color/theme + add legend ]

```{r histogram, echo=F, warning=F, message=F}

# Histogram
niveau.ts %>% 
  ggplot() + 
  geom_histogram(mapping = aes(Wert),
                 stat = "count") +
  
  # Adds smoothed version of the histogram
  geom_density(mapping = aes(Wert), stat = "density", colour = "red") + 
  
  # Adds the mode
  #geom_vline(xintercept = mode(niveau.ts$Wert),       
             #col = "blue",
             #lwd = 1) +
  
  # Adds the mean
  geom_vline(xintercept = mean(niveau.ts$Wert),       
             col = "green",
             lwd = 1) +
  
  # Adds the median
  geom_vline(xintercept = median(niveau.ts$Wert),       
             col = "purple",
             lwd = 1) +

  labs(title = "Water Levels Frequencies",
       x = "Water Level Value [meter above sea]",
       y = "Frequency") +
  
  # Adds legend
  theme(legend.position="right")

```

# Extreme Value Analysis (EVA)

The objective behind the EVA is to find valid estimates of the frequency (expressed as a return period) of extreme water levels maxima. -> return level is the output 

[Add assumptions about observed extreme values from the theory]

## Peak-Over-Threshold (POT) Method

The **Peaks-over-Threshold** method identifies values that are high enough to be above a designated threshold $\mu$, to show the extremes (i.e. highest values). In order to determine an optimal threshold, we apply the **MRL-plot** and then look at the distribution of the data points [exceeding the threshold right ?]. [The number of exceedances arise according to a *Poisson* distribution with parameter lambda (i.e. probability of getting an exceedance)]. 

The value of $\mu$ from which the plot becomes approximately linear can generally be selected as the optimal threshold. [not sure I understand this sentence] Therefore, to model the high water levels, we first proceed to an MRL-plot to choose the optimal threshold $\mu$ and then, we use the Peaks-over-Threshold method [we look at the distribution of the exceedances to assess their probability of occurrence].

## Clustering of the extremes

Clusters of the extremes correspond to the clustering of the data points that are above the chosen threshold u.Consecutive threshold exceedances are considered to belong to the same cluster.
In our case, concerning the daily water levels data, by using the Peak-over-Threshold approach we can observe thanks to the plot the different clusters of the extreme values, then we can fit the Generalized Pareto Distribution (GPD) or Point Process Model to the cluster maxima (after declustering if the exceedances exhibit autocorrrelation).

- [drawbacks and advantages of using block maxima method instead ]

## Analysis

First, we start by selecting an appropriate threshold $\mu$ to use for fitting the GPD or point process models. To do so, we use the *mrlplot()* function from the **extRemes** package which plots the potential thresholds against the mean excess.

The mean excess is calculated by $(mean\ of \ exceedances \ of \ \mu - \mu)$

The difficulty of choosing an adequate threshold $\mu$ lies in the fact that it requires a good balance between selecting a threshold low enough so that we have enough exceedances to obtain useful results (i.e. results precision) but high enough so that the GPD and point process methods are approximately valid (i.e. bias). 

[Notes for ourselves in case of a question: "If we take the threshold to be so low that most of the data are exceedances then the analysis will only be valid if the raw data came from a generalised Pareto distribution (which will rarely be the case)"]

The below **Mean Residual Life Plot** indicates for each potential threshold $\mu$ its mean excess. As mentioned previously, the value of $\mu$ from which the plot becomes approximately linear can generally be selected as the optimal threshold. From the plot, we therefore decide to choose a threshold $\mu = 327\ [m.a.s.l]$. 

```{r extremes, echo=F, warning=F, message=F}

library(extRemes)

# Mean Residual Life Plot (MRLP)
extRemes::mrlplot(niveau.ts$Wert,) 
#+ labs(title = "Mean Residual Life Plot",
       #caption = "source: niveau.Rdata")

# [ADD A VERTICAL LINE AT 327 TO SHOW THE DIFFERENCE OF THE LINE FROM CURVE TO LINEAR!]

```

The threshold could be put at around 326 or 327.

```{r peaks-over-threshold, echo=F, warning=F, message=F}

threshold <- 327 # 327 as Threshold looks better than 326

# Plot of Peak-over-Threshold
plot(x = rep(1:7883, each = 1), 
     y = unlist(niveau.ts$Wert), 
     main = "Peaks Over Thresholds",
     sub = paste("threshold =", threshold), 
     xlab = "series", 
     ylab = "Water Level Values")

pot_points <- unlist(niveau.ts$Wert) > threshold

points(x = rep(1:7883, each = 1)[pot_points], 
       y = unlist(niveau.ts$Wert)[pot_points], 
       col = "red")

abline(h = threshold, col = "red")

```

Declustering: rendre indÃ©pendentes les unes des autres les exceedances (i.e. data points above the threshold)
-> we want to decluster to water level values above 327 meter above sea.

```{r decluster, echo=F, warning=F, message=F}

# Decluster 
decluster <- extRemes::decluster(niveau$Wert, 
                                 threshold = 327)

decluster

#summary(decluster) 

plot(decluster) +
labs(title = "Declustering of exceedances",
     caption = "source: niveau.Rdata",
     y = "Water Level Values")

```

```{r log return, echo=F, warning=F, message=F}

# Log return
ret <- diff(log(niveau.ts$Wert))

plot(niveau.ts$Zeitpunkt_des_Auftretens[-1],
     100*ret,
     type ="l",
     main = "log return over time",
     xlab ="Time",
     ylab ="log return in %",
     col = 1) +

points(niveau.ts$Zeitpunkt_des_Auftretens[-1],
       100*ret,
       col = 2,
       cex = 0.1)

```

## GPD

```{r GPD, echo=F, warning=F, message=F}

# GPD: 1st way of using Peak-over-Threshold data
gpd <- extRemes::fevd(unlist(decluster), 
                      threshold = threshold, 
                      type = "GP")

plot(gpd, 
     type = "density", 
     main = "Empirical POT vs estimated GPD")

```

```{r return level with GDP, echo=F, warning=F, message=F}

# [Make sure its in yearly terms + return level for 50-year AND 100-year]

# Plot of the Return Level
plot(gpd, 
     type = "rl", 
     main = "Return level")

```

## Point Process Model

```{r point process, echo=F, warning=F, message=F}

# Point Process Model: 2nd way of using Peak-over-Threshold data
pt_pro <- fevd(unlist(niveau.ts$Wert), 
               threshold = threshold, 
               type = "PP")

plot(pt_pro, 
     type = "density", 
     main = "Empirical POT vs Point Process")

```

```{r return level with point process, echo=F, warning=F, message=F}

# Plot of the Return Level
plot(pt_pro, 
     type = "rl", 
     main = "Return level")

```

